---
date: 2023-05-21 00:00:00
layout: post
title: k8s 구성요소 - 볼륨과 스테이트풀셋 
subtitle: Kubernetes, k8s
description: 파드 그 자체는 Stateless, 파드의 교체와 배치를 담당하는 것이 '디플로이먼트', 레플리카셋을 통해 파드를 scale out하며, 이때 만들어지는 파드들은 상호 대체 가능합니다.
image: https://res.cloudinary.com/dvqcvocet/image/upload/v1684335849/%E1%84%8F%E1%85%AE%E1%84%87%E1%85%A5%E1%84%8C%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3_yoqeyy.png
optimized_image: https://res.cloudinary.com/dvqcvocet/image/upload/v1684335849/%E1%84%8F%E1%85%AE%E1%84%87%E1%85%A5%E1%84%8C%E1%85%B5%E1%86%AB%E1%84%89%E1%85%B3_yoqeyy.png
category: k8s
tags:  
  - kubernetes
  - k8s
  - pod
  - workload
  - 워크로드

author: Hoonology
paginate: true
---
# 볼륨과 스테이트풀셋

![volume](/assets/img/kubernetes/volume.png)
## 파드 : Stateless
- 파드 : 일시적, 언제나 삭제될 수 있으므로, 'Stateless' 
- 디플로이먼트 : 파드의 교체와 배치를 담당
  - '레플리카셋'을 통해 파드를 scale out, 생성된 파드들은 상호 대체 가능

## 파드 삭제 후 데이터 남기기
- 파드의 데이터를 남겨야할 때 사용하는 'Statefull' DB 애플리케이션을 사용한다.
  - MySQL, mongoDB, edis
  - DB를 담은 파드 삭제 시 데이터가 삭제되는 것을 방지하기 위해 '**볼륨**'을 연결한다.
- 파드에 볼륨을 연결하면, 데이터를 영속적으로 저장하는 것이 가능하다.

![vol2](/assets/img/kubernetes/ebs.png)

#### 볼륨과 퍼시스턴스 볼륨(Persistence Volume)은 어떤 차이가 있나요? AWS EC2에도 비슷한 개념이 있습니다. EBS와 인스턴스 스토어 볼륨의 차이점과 연결해서 설명해 주세요.


AWS EC2의 맥락에서 **EBS**(Elastic Block Store) 및 **인스턴스 스토어 볼륨**의 개념을 이해하는 것부터 시작하겠습니다.  


**EBS 볼륨**은 EC2 인스턴스에 <u>영구 블록 수준 스토리지를 제공하는 네트워크 연결 스토리지 장치</u>입니다. 이는 **인스턴스의 수명 주기와 독립적**입니다. 즉, **EBS 볼륨에 저장된 데이터는 인스턴스가 중지되거나 종료된 후에도 지속**됩니다. EBS 볼륨은 내구성과 안정성을 위해 설계되었으며 스냅샷, 암호화, 인스턴스에서 볼륨을 연결/분리하는 기능과 같은 기능을 제공합니다.


반면 **임시 스토리**지라고도 하는 **인스턴스 스토어 볼륨**은 EC2 인스턴스의 호스트 서버에 물리적으로 연결된 임시 블록 수준 스토리지 장치입니다. 이러한 볼륨은 지연 시간이 짧은 **고성능 스토리지**를 제공하지만 인스턴스가 중지되거나 종료되거나 기본 하드웨어에 장애가 발생하면 **볼륨에 저장된 데이터가 손실**된다는 중요한 특성이 있습니다.


이제 이러한 개념을 보다 일반적으로 "볼륨" 및 "지속성 볼륨"이라는 용어에 연결해 보겠습니다.
더 넓은 맥락에서 "**볼륨**"은 일반적으로 **가상 머신이나 컨테이너와 같은 컴퓨팅 리소스에 연결할 수 있는 논리적 스토리지 단위**를 나타냅니다. 데이터 저장 및 검색을 위한 파일 시스템 인터페이스를 제공합니다.

**Kubernetes에서 "영구 볼륨"(PV)은 포드 정의에서 스토리지 구성을 분리하는 스토리지 추상화**입니다. 클러스터에서 스토리지 리소스를 프로비저닝하고 관리하는 방법을 제공합니다. 영구 볼륨은 클러스터의 저장소(예: 디스크, 네트워크 연결 저장소 또는 클라우드 저장소 장치)를 나타내는 Kubernetes 리소스입니다.  
볼륨과 영구 볼륨의 주요 차이점은 지속성 측면입니다. 일반 볼륨은 모든 저장 장치에 대한 일반적인 용어이지만 영구 볼륨은 포드 또는 컨테이너의 수명 주기 동안 지속되는 내구성 있고 지속적인 스토리지를 제공하도록 특별히 설계되었습니다.

![pv](/assets/img/kubernetes/pv.png)

(storage:iGi가 아닌, 1Gi _ 오타수정)

> 요약하자면, AWS EC2 컨텍스트에서 **EBS 볼륨**은 <u>인스턴스가 중지되거나 종료된 경우에도 유지되는 영구 스토리지를 제공</u>하는 반면, **인스턴스 스토어 볼륨**은 인스턴스의 수명 주기 이상으로 지속되지 않는 <u>임시 고성능 스토리지를 제공</u>합니다.   

**Kubernetes 컨텍스트에서 영구 볼륨(PV)**은 파드에서 분리되어 컨테이너화된 애플리케이션에 영구 스토리지를 제공하는 내구성 있는 스토리지 리소스를 나타냅니다.


## Stateful한 애플리케이션 관리
파드 명세에 PV를 정의해서 직접 연결하는 것은 좋은 방법이 아닙니다.

> 이러한 의존도를 줄이기 위해, 퍼시스턴스 볼륨 클레임(Persistence Volume Claim, 이하 PVC)을 이용하여 PV와 연결합니다. PVC는 파드가 볼륨의 세부 사항을 몰라도 볼륨을 사용할 수 있게 도와줍니다.

- PV는 실제로 데이터가 저장되는 공간입니다.
- PVC는 PV를 선택, 연결해 주는 요청 그 자체입니다.


#### 왜 파드와 PV를 직접 연결하는 것이 좋지 않은가요?
- 유연성 및 이식성: Pod는 일시적으로 생성, 소멸 또는 동적으로 노드 간에 이동할 수 있습니다. 포드를 PV에 직접 연결하면 견고하게 결합되어 유연성과 휴대성이 제한됩니다. 포드를 이동하거나 일정을 변경해야 하는 경우 PV를 분리했다가 다시 연결해야 하므로 작업이 중단되고 다운타임이 발생할 수 있습니다.
- 스토리지 프로비저닝 분리: PV를 추상화 계층으로 사용하여 포드 정의에서 스토리지 프로비저닝 프로세스를 분리합니다. 이를 통해 관리자 또는 운영자는 스토리지 리소스를 독립적으로 관리하여 더 많은 제어 및 유연성을 제공할 수 있습니다. 또한 팟(Pod) 사양을 수정하지 않고도 다양한 팟(Pod)에 다양한 스토리지 클래스 및 유형을 사용할 수 있습니다.
- 동적 프로비저닝: Kubernetes의 스토리지 클래스를 사용하여 PV를 동적으로 프로비저닝할 수 있습니다. 즉, 지정된 정책 및 요구 사항에 따라 필요에 따라 PV가 자동으로 생성될 수 있습니다. 포드를 PV에 직접 연결하면 이 동적 프로비저닝 메커니즘을 우회하여 스토리지 리소스를 효율적으로 확장하고 관리하는 기능이 제한됩니다.
- 다중 포드 액세스: 많은 경우 여러 포드가 동일한 영구 볼륨에 동시에 액세스해야 할 수 있습니다. 포드를 PV에 직접 연결하면 액세스 및 동기화를 수동으로 관리해야 하므로 복잡하고 오류가 발생하기 쉽습니다. 영구 볼륨 클레임(PVC)의 Kubernetes 추상화를 사용하여 동일한 PV에 액세스하는 포드 간에 적절한 액세스 제어 및 조정을 보장할 수 있습니다.
- 향후 호환성: Kubernetes는 진화하는 플랫폼이며 새로운 기능, 스토리지 옵션 및 개선 사항이 지속적으로 도입되고 있습니다. PV를 중간 계층으로 사용하면 스토리지 환경의 향후 업데이트 및 변경 사항과의 호환성을 보장할 수 있습니다. 포드가 PV에 직접 연결된 경우 Kubernetes 스토리지 하위 시스템의 변경 또는 개선을 위해 포드 구성을 크게 수정해야 할 수 있습니다.


## Stateful한 애플리케이션이 수평 확장한다면
파드를 정의할 때 PVC를 통해 볼륨에 연결할 수가 있습니다. 그런데, 그냥 이러한 파드를 디플로이먼트로 배포해도, **PVC를 통해 연결되는 볼륨은 하나이기 때문에, 결국 같은 스토리지를 사용하는 모양새**가 됩니다.


![Alt text](https://s3.ap-northeast-2.amazonaws.com/urclass-images/hlEhZmhAzKDKCuc5fQC4r-1650398862538.png)



**파드마다 별도의 데이터를 저장**할 수 있게 만들려면, **수평확장되는 파드에 서로 다른 PV가 연결**되어야 합니다. 파드가 PV를 동적으로 요청해서 그때그때 볼륨이 생성되게 하면 어떨까요? **스토리지 클래스(StorageClass)** 리소스는 사용자가 요청할 때, **자동으로 PV를 프로비저닝 할 수 있게 돕습니다.**

> 참고 : [url](https://kubernetes.io/ko/docs/concepts/storage/dynamic-provisioning/)

![Alt text](https://s3.ap-northeast-2.amazonaws.com/urclass-images/9mrE0wievDmSR9yeTbnF1-1650398888796.png)

![pvc](/assets/img/kubernetes/binding.png)
![pvc2](/assets/img/kubernetes/binding2.png)

## 스테이트풀셋
애플리케이션 **구성(파드)을 복제**하더라도, **스토리지 클래스**를 이용해 파드가 필요로 하는 볼륨을 자동으로 프로비저닝하여 연결합니다. 따라서 첫 번째 파드를 primary(master), 두 번째 파드를 secondary 복제본처럼 구성하는 것도 가능합니다.

> 디플로이먼트와 스테이트풀셋은 둘 다 동일한 컨테이너 스펙을 기반으로 둔 파드들을 관리합니다.  
하지만, 스테이트풀셋은 **파드의 순서와 고유성을 보장**합니다.  
즉, 스테이트풀셋이 생성한 파드는 대체할 수 없는 파드가 된다는 의미입니다.

## 스테이트풀셋 주의사항
- 파드에 지정된 스토리지는 관리자에 의해 **퍼시스턴트 볼륨 프로비저너**를 기반으로 하는 **storage class**를 요청해서 프로비전하거나 사전에 프로비전이 되어야 한다.
- **헤드리스 서비스**가 필요하다.

#### Q. 네트워크 트래픽에 따라 요청이 랜덤하게 분산되는 일반적인 서비스에 비해, 헤드리스 서비스는 특정 스테이트풀셋에게 트래픽을 보냅니다. 왜 그렇게 해야 하나요?

- **안정적인 네트워크 ID**: Kubernetes의 **StatefulSet**는 **안정적인 네트워크 ID와 영구 스토리지**가 필요한 상태 저장 애플리케이션을 관리하도록 **설계**되었습니다. StatefulSet의 각 인스턴스에는 고유한 호스트 이름과 안정적인 네트워크 ID가 있습니다. **헤드리스 서비스**를 사용하면 안정적인 네트워크 ID로 특정 인스턴스에 **직접 액세스**할 수 있습니다.
- **결정적 통신**: 일부 애플리케이션에는 인스턴스 간에 결정적 통신 패턴이 필요합니다. **헤드리스 서비스를 사용하면 트래픽이 전달되는 방식을 제어**할 수 있으므로 **StatefulSet의 인스턴스 간에 특정 통신 패턴이나 프로토콜을 구현**할 수 있습니다. 이는 특정 인스턴스 간의 조정이 필요한 분산 시스템, 데이터베이스 또는 응용 프로그램에 특히 유용합니다.
- 순서가 지정된 작업: 어떤 경우에는 작업 순서 또는 순서가 응용 프로그램의 정확성에 매우 중요합니다. 헤드리스 서비스는 요청이 특정 순서로 StatefulSet의 인스턴스로 라우팅되도록 하여 조율되고 정렬된 작업 처리를 가능하게 합니다. 이는 엄격한 순서 또는 순차적 처리에 의존하는 애플리케이션에 특히 중요합니다.
- 향상된 제어 및 모니터링: 헤드리스 서비스를 사용하면 StatefulSet 인스턴스에 대한 트래픽 흐름을 세밀하게 제어하고 볼 수 있습니다. 애플리케이션 요구 사항에 맞는 사용자 정의 로드 밸런싱, 라우팅 또는 트래픽 관리 메커니즘을 구현할 수 있습니다. 이 수준의 제어를 통해 더 나은 모니터링, 관찰 가능성 및 디버깅 기능을 사용할 수 있습니다.
- 맞춤형 서비스 검색: 헤드리스 서비스는 일반 서비스처럼 로드 밸런싱 또는 서비스 검색을 자동으로 제공하지 않습니다. 대신 StatefulSet의 개별 인스턴스에 대한 DNS 이름을 반환합니다. 이를 통해 사용자 지정 서비스 검색 메커니즘을 구현하여 애플리케이션 요구 사항에 맞는 보다 맞춤화되고 전문화된 검색 솔루션을 사용할 수 있습니다.

헤드리스 서비스가 모든 시나리오에 적합하지 않을 수 있다는 점에 유의하는 것이 중요합니다. 이들은 특정 통신 패턴, 결정론적 순서 또는 네트워크 트래픽에 대한 세분화된 제어가 필요한 상태 저장 애플리케이션 또는 분산 시스템에서 주로 사용됩니다. 상태 비저장 애플리케이션이나 로드 밸런싱 및 자동 서비스 검색이 더 중요한 경우에는 일반적으로 일반 서비스가 선호됩니다.


#### Q1. 애플리케이션에 HTTP 500과 같은 에러가 발생한 경우, 컨테이너를 다시 실행해야 할 것입니다. HTTP 에러가 발생했다는 것을 어떻게 알 수 있을까요? 어떻게 해야 쿠버네티스가 에러가 발생한 컨테이너를 자동으로 재시작하게 만들 수 있을까요? (힌트: liveness probe 키워드를 검색하세요)

컨테이너 내의 애플리케이션이 HTTP 500과 같은 HTTP 오류를 발생시키는지 감지하려면 Kubernetes에서 활성 프로브를 활용할 수 있습니다. 활동성 프로브는 컨테이너의 상태를 주기적으로 확인하고 제대로 작동하는지 확인하는 메커니즘입니다. 애플리케이션의 특정 엔드포인트에 요청을 보내고 HTTP 응답 코드를 검사하는 HTTP 기반 활동성 프로브를 구성할 수 있습니다.


500 상태 코드와 같은 HTTP 오류가 활동성 프로브에 의해 감지되면 Kubernetes는 컨테이너가 실패한 상태인 것으로 간주합니다. 기본적으로 Kubernetes는 활동성 프로브에 실패한 컨테이너를 자동으로 다시 시작합니다.


Kubernetes 매니페스트 파일에서 활동성 프로브를 구성하려면 다음 키워드를 사용할 수 있습니다.


livenessProbe: 이 필드는 활성 프로브에 대한 매개변수를 지정합니다. 프로브 유형(예: HTTP, TCP 또는 명령), 확인할 경로 또는 포트 및 기타 관련 설정을 정의할 수 있습니다.
initialDelaySeconds: 이 매개변수는 컨테이너가 시작된 후 첫 번째 활성 프로브를 수행하기 전에 Kubernetes가 대기해야 하는 시간(초)을 결정합니다.
periodSeconds: 이 매개변수는 후속 활성 프로브가 발생해야 하는 빈도를 설정합니다.
failureThreshold: 이 매개변수는 컨테이너가 실패한 것으로 간주하는 데 필요한 연속 프로브 실패 횟수를 정의합니다.

적절한 활성 프로브를 구성하고 다시 시작 정책을 기본값("항상")으로 두면 Kubernetes는 HTTP 오류가 발생하거나 활성 프로브에 실패한 컨테이너를 자동으로 다시 시작합니다. 이렇게 하면 애플리케이션이 계속 실행되고 오류 복구를 시도할 수 있습니다.

#### Q2. 왜 파드와 PV(퍼시스턴스볼륨)를 직접 연결하지 않는 걸까요?
 다음과 같은 몇 가지 이유로 인해 Kubernetes의 PersistenceVolume(PV)에 포드를 직접 연결하는 것은 권장되지 않습니다.


유연성 및 이식성: Kubernetes의 포드는 임시로 설계되었습니다. 즉, 동적으로 생성, 이동 또는 종료될 수 있습니다. Pod를 특정 PV에 직접 연결하면 서로 긴밀하게 연결되므로 PV를 분리했다가 다시 연결하지 않고 Pod를 재배치하거나 일정을 변경하기가 어렵습니다. 이는 애플리케이션의 유연성과 이식성을 감소시킵니다.
동적 프로비저닝: Kubernetes는 PersistentVolumeClaim(PVC)에 지정된 요구 사항을 기반으로 PV를 동적으로 프로비저닝하는 기능을 제공합니다. 이를 통해 PV를 직접 지정하지 않고도 스토리지 리소스를 주문형으로 할당할 수 있습니다. 포드가 특정 PV에 직접 연결되면 동적 프로비저닝 메커니즘을 우회하여 진화하는 애플리케이션 요구 사항에 따라 추가 스토리지 용량 또는 다른 스토리지 클래스의 활용을 방지합니다.
추상화 및 관리 용이성: PVC를 중간 계층으로 활용하여 기본 스토리지 구현 세부 정보에서 포드를 분리합니다. PVC는 스토리지 요청을 나타내고 PV는 실제 스토리지 리소스를 나타냅니다. 이 추상화 계층을 통해 관리자 또는 운영자는 스토리지 리소스를 독립적으로 관리하고 할당하여 더 나은 제어, 모니터링 및 확장성을 제공할 수 있습니다.
다중 포드 액세스: 많은 경우 공유 데이터베이스 또는 분산 파일 시스템 설정과 같이 여러 포드가 동일한 PV에 동시에 액세스해야 할 수 있습니다. Pod를 PV에 직접 연결하면 수동 조정 및 동기화가 필요하므로 동시 액세스 관리가 어려워집니다. PVC 및 적절한 액세스 제어 메커니즘을 사용하여 PV에 대한 원활하고 제어된 다중 포드 액세스를 활성화할 수 있습니다.

PVC를 추상화 계층으로 활용하고 Pod를 PV에서 분리하면 Kubernetes에서 더 나은 유연성, 확장성 및 관리 용이성을 얻을 수 있습니다. 영구 스토리지 리소스의 동적 프로비저닝, 이식성 및 단순화된 관리를 허용하므로 Kubernetes 배포에서 권장되는 접근 방식입니다.