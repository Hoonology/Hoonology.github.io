---
date: 2023-05-31 00:00:00
layout: post
title: 서비스 모니터링
subtitle: 서비스 모니터링
description: CI/CD 파이프라인 중 가장 마지막 단계인 운영에 있어 필요한 측정 항목(metric)과 AWS의 대표적인 모니터링 도구인 CloudWatch를 좀 더 잘 다룰 수 있게 연습합니다. 또한, 쿠버네티스 환경에서 사용하는 Prometheus와 Grafana 조합을 살펴봅니다.
image: https://res.cloudinary.com/dvqcvocet/image/upload/v1681954803/eoe0iiqoeiq9ghldrltc.png
optimized_image: https://res.cloudinary.com/dvqcvocet/image/upload/v1681954803/eoe0iiqoeiq9ghldrltc.png
category: mornitoring
tags:  
  - 모니터링
  - mornitoring
  - observability

author: Hoonology
paginate: true
---
# Index
- [모니터링의 목표](#모니터링의-목표)
- [모니터링 구분](#모니터링-구분)
# 클라우드 인프라 전환 시대에 살아남기
**Observability**

오직 시스템의 외부 출력만을 이용해서 시스템의 현재 상태를 이해할 수 있는 능력

모니터링의 필요성 
- 모니터링 구분
- 계층별 메트릭
  - 골든 시그널

- 장기추세 분석
  - 데이터베이스의 크기와 확장속도는 어느정도인가?
  - 일일 활성 사용자 수가 얼마나 빨리 증가하는가?
- 시간 경과에 따른 비교 또는 실험
  - A 버킷의 바이트 2.72.를 사용하면 Ajax DB 3.14 보다 쿼리 속도가 빨라지는가 ?

- Alarm  
  - 무언가 고장이 나서 누군가 지금 당장 고쳐야합니다.

- 시각화 : 대시보드 작성
- 디버깅

# 모니터링을 왜 할까 ?
운영 : CI/CD 파이프라인의 마지막 Stage
- 서비스에 생길수 있는 현황 파악 , 문제를 모니터링하는 과정 
- 어떤 지표와 어떤 **메트릭**을 기준으로 삼을까?

> 메트릭 : **시간에 따라 측정한 결과값** ( **비즈니스 개념을 나타내는 수치 측정**)

## 모니터링의 목표
- 메트릭 최소화 - **고가용성** 달성
- 사용량을 추적하여 배포에 앞서 세운 **가설을 검증하고 개선**
  - 검증된 학습을 적용한다.

#### 구글에서 이야기하는 모니터링의 목표와 메트릭
 SRE : [https://sre.google/sre-book/monitoring-distributed-systems/](https://sre.google/sre-book/monitoring-distributed-systems/)
- 장기적인 트렌드 분석
  - 데이터베이스가 얼마만큼의 용량을 차지하고 얼마나 빨리 증가하는가
  - DAU (일간 활성 사용자수)는 얼마나 빨리 증가하는가
- 시간의 경과 및 실험 그룹 간의 비교
  - 어떤 데이터베이스를 썼을 때 쿼리가 빠른가
  - 캐시용 노드를 추가했을 때, 캐시 적중률이 얼마나 향상되는가
  - 지난주보다 사이트가 얼마나 느려졌는가
- 경고
  - 인프라의 어떤 부분이 고장났고, 혹은 고장이 발생할 수 있는가


#### 마이크로소프트에서 이야기하는 모니터링의 목표와 메트릭
[Azure Data Explorer 성능, 상태 및 사용량 모니터링](https://learn.microsoft.com/ko-kr/azure/data-explorer/using-metrics)
- 캐시 사용률
- CPU, Memory
- 인스턴스의 개수
- 연결 유지

# 모니터링 구분 
> 모니터링을 하는 이유는 간단하게 말하면, 서비스가 제대로 작동하기 확인하기 위함입니다.  
너무 많은 메트릭을 모니터링하면 중요한 신호를 발견하기 어렵습니다. 이에 따라 단계를 구분하여 계층적으로 모니터링을 할 필요가 있습니다.




## 블랙박스 모니터링 , 화이트박스 모니터링
박스를 기준으로 관찰자가 밖에서 바라보느냐, 안에서 바라보느냐의 차이입니다. 박스는 애플리케이션이 될 수도 있고, 쿠버네티스 시스템이 될 수도 있습니다.
#### 화이트박스 모니터링
**시스템 내부**의 측정 기준에 따라 모니터링하는 것
- 현상만 바라보는 것이 아닌, 현상이 발생한 근거를 알 수 있는 모니터링 방식
- 로그, JVM(Java Virtual Machine) 프로파일링 인터페이스와 같은 인터페이스 또는 내부 통계를 생성하는 HTTP 핸들러를 포함하여 시스템 내부에서 노출되는 메트릭을 기반으로 모니터링합니다.
-  HTTP 요청, 500 에러의 발생 횟수, 레이턴시 등
#### 블랙박스 모니터링
사용자가 보는 것처럼 **외부에 보이는 동작**을 테스트합니다.
- CPU/메모리/스토리지 등 인프라 수준의 모니터링에 유리하다. 
- 쿠버네티스 : 클러스터 정상 작동 여부 등 k8s 컴포넌트 그 자체를 모니터링
- **애플리케이션이 오류가 나는 원인 확인 불가**

## 계층에 따른 모니터링 구분
- 쿠버네티스
  - 노드 > 클러스터 컴포넌트 > 파드
- ECS
  - 클러스터 > 서비스 > 파드
- EC2 : 인스턴스에 대한 메트릭만 볼 수 있다.
- Lambda : 함수에 대한 메트릭만 볼 수 있다.

## Proxy 서버의 메트릭
애플리케이션 서버(WAS)의 앞단에 캐시 서버 혹은 인증 서버, 로드 밸런서와 같은 Proxy 서버가 존재한다면, 이는 애플리케이션 서버와는 별도로 모니터링해야 합니다. 애플리케이션 서버가 각 노드의 컴퓨팅 자원을 모니터링하는 데에 중점을 두었다면, Proxy 서버, 그중에서도 HTTP 라우팅을 다루고 있는 서버는 요청 그 자체와 연관된 메트릭을 위주로 모니터링해야 합니다.

HTTP 요청/응답 관련 모니터링 대상은 쿠버네티스의 경우 인그레스, AWS 생태계에서는 Application Load Balancer를 중점으로 보아야 합니다.