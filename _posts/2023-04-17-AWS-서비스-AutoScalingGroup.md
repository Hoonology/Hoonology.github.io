---
date: 2023-04-18 00:00:00
layout: post
title: AWS 서비스 - 수평확장
subtitle: AWS 서비스 수평확장에 대하여
description: Auto Scaling - Auto Scaling Group, Elastic Load Balancing(ELB)의 장점과 설명 
image: https://res.cloudinary.com/dvqcvocet/image/upload/v1681432465/dev-jeans_%E1%84%87%E1%85%A9%E1%86%A8%E1%84%89%E1%85%A1%E1%84%87%E1%85%A9%E1%86%AB_y5n0eh.png
optimized_image: https://res.cloudinary.com/dvqcvocet/image/upload/v1681432465/dev-jeans_%E1%84%87%E1%85%A9%E1%86%A8%E1%84%89%E1%85%A1%E1%84%87%E1%85%A9%E1%86%AB_y5n0eh.png 
category: AWS
tags:
  - AWS
  - cloud
  - EC2
  - Auto Scaling Group
  - 로드밸런싱
  - Elastic Load Balancing
  - ELB
  
author: Hoonology
comments: true

---

# Auto Scaling Group

# Auto Scaling
미리 정해 놓은 규칙에 따라 워크로드(작업량)를 자동으로 **확대 또는 축소할 수 있는 기술**로 클라우드가 제공하는 탄력성에 의해 만들어지고, 사용자의 요구 수준을 반영할 수 있는 기술
- 요구량이 급등하는 시기, 즉 '**피크 워크로드**'에 맞춰 새 리소스를 자동으로 추가하고 환경설정하고, 처리 요구량이 줄어들면 해당 리소스를 감소시키기 때문에,  
 **과잉 프로비전**(필요한 컴퓨팅 리소스들을 필요한 곳에 배치, 유휴 자원들을 다시 회수하는 일련의 작업들)을 할 필요성이 **사라집니다**.


## 장점 

- 동적 스케일링( Dynamic Scaling ) : 사용자의 요구 수준에 따라 리소스를 동적으로 스케일링 할 수 있다. 
  - Scale Up 제한 X - 서버 두 대에서 수백 ~ 수천 수만의 서버로 즉시 스케일 업 가능
- 로드 밸런싱 : 리소스를 동적으로 Scale Up & Down 하는데, **로드밸런서와 함께 사용하면 다수의 EC2 인스턴스에게 워크로드를 효과적으로 분배**할 수 있다.
  - 사용자가 정의한 규칙에 따라 워크로드를 효과적으로 관리
- 타겟 트래킹 : 사용자는 특정 타겟에 대해서만 Auto Scaling 가능 - EC2 인스턴스의 수도 이와 맞게 조정
- **헬스 체크**와 서버 플릿 관리 : EC2 인스턴스에서 발생하는 헬스 체크 상태를 모니터링한다. 
  - **자동으로 다른 인스턴스로 교체**
  - > - 서버 플릿( Fleet ) : **다수의 EC2 서버**에서 애플리케이션 **호스팅** 할 때의 **EC2 서버의 집합**   
      적정 수준의 용량을 유지하는데에 도움을 준다.
    >  - 헬스 체크 상태를 모니터링해서 문제가 발생한 서버가 발견되면 즉시 대응하고 조치한다. 기존 서버가 모두 다운될 경우, Auto Scaling은 서버 인스턴스의 용량을 유지하기 위하여 서버를 추가로 실행한다.


## EC2 Auto Scaling 활용 
EC2 인스턴스 뿐 아니라 다른 인스턴스와도 결합이 가능하지만, EC2 이용자들에게 가장 많이 활용된다.

### 시작 템플릿( Launch Configuration )
Auto Scaling을 활용해 인스턴스의 확장/축소하기 위해 어떤 서버를 사용할지 결정한다.(템플릿 활용)

> 템플릿 내용 : AMI 상세 정보, 인스턴스 타입, 키 페어, 시큐리티 그룹 등 인스턴스에 대한 모든 정보  
  시작 구성 : 사용할 AMI의 ID, 인스턴스 유형, 키 페어, 보안 그룹 등의 정보를 포함시켜서 시작 구성을 생성한다.(템플릿 활용하지 않은 경우)

### Auto Scaling Group 생성
Auto Scaling Group : Scale Up & Down 규칙의 모음, **EC2 인스턴트의 시작 ~ 삭제 까지의 모든 동작에 대한 규칙과 정책**을 포함  

### Scaling 유형
  - 동적 스케일링 ( Dynamic Scaling ) : 자동화된 스케일링 기능을 사용하여, 인스턴스의 CPU 사용률, 메모리 사용률, 네트워크 트래픽 등을 모니터링하고, 설정된 임계값에 도달하면 자동으로 인스턴스 수를 늘리거나 줄임 ( **실시간성**이 높은 방법 )
    - 애플리케이션의 수요가 예측하기 어려운 경우에 활용!
    - 타겟 트랙킹 스케일링 : 미리 정의된 성능 지표를 이용하거나, 커스텀 성능지표(custom metric)을 사용하여 타겟 값으로 설정
    - 단순 스케일링 : 단 하나의 스케일링 설정에 따라 그룹의 현재 용량을 늘리거나 줄인다.
      - 예를 들어 CPU 활용지표가 80% 에 도달할 때 하나의 인스턴스를 추가하고, 40% 미만으로 떨어질 때 인스턴스 하나를 감소시키는 방식
      - 새 인스턴스를 시작 혹은 정지 시키기 위한 **대기 시간**도 정의 (= **쿨다운 기간**)
    - 단계 스케일링 : 단순 스케일링은 특정 이벤트에 대해 매번 같은 액션을 한다면, 단계 스케일링은 좀 더 세분화 해서 단계를 나누어 규칙을 추가할 수 있다.


  - 수동 스케일링 ( Manual scaling ) : 애플리케이션의 수요에 따라 확장하거나 축소하는 것 ( 추천 X )
  - 인스턴스 레벨 유지( Instance-level persistence ) : 기본 스케일링 계획, 항상 실행 상태를 유지하고자 하는 인스턴스의 수를 지정할 수 있다. 
    - 일반적으로 객체의 상태는 해당 객체가 메모리에 로드되는 동안만 유지됩니다. 그러나 이 상태를 유지하기 위해 인스턴스 레벨 유지를 사용하면, 해당 객체가 종료되어도 해당 상태를 유지할 수 있다.
  


  - 예측 스케일링( Predictive Scaling ) : 애플리케이션의 예측된 수요를 기반으로 인스턴스 수를 자동으로 조정, 트래픽의 변화를 예측할 수 있고, 특정 시간대에 어느 정도의 트래픽이 증가하는지 패턴을 파악하고 있다면 일정별 스케일링을 사용하는 것이 좋다.
    - 트래픽이 많은 시간대에 서버를 늘리고, 낮은 시간대에 줄인다.
  

### 인스턴스 삭제 정책
Auto Scaling **Down** 시, **EC2 인스턴스 삭제** ( 과금 부담을 줄일 수 있다. )
- 리소스 관리 측면에서 유리한 작업
- 명확하게 어떤 인스턴스를 몇개 삭제할 것인지 정의를 내릴 수 있다.
  1. 사용자의 서버 플릿에서 가장 오랫동안 실행된 서버를 삭제
  2. 시간 단위 과금이 임박한 서버를 삭제


# Elastic Load Balancing( ELB )
**로드 밸런싱** : 서비스를 **단일 서버**로 구성하면 해당 서버의 애플리케이션, 운영체제, 하드웨어에 장애가 발생했을 때 **정상적인 서비스를 제공할 수 없다**.  
**서비스 가용성**을 **높이기 위해** 하나의 서비스는 보통 두 대 이상의 서버로 구성, 각 서버의 IP 주소가 다르므로 사용자가 서비스를 호출할 때는 어떤 IP로 서비스를 요청할지 결정해야 하며, 이에 **로드 밸런서**를 사용한다.
- 동일한 서비스를 하는 다수의 서버가 등록
- 서비스 요청 시, 다수의 서버에 서비스 요청을 분산하여 부하 방지

## ELB
AWS에서 제공하는 로브 밸런싱 서비스 
- EC2 인스턴스, 컨테이너, IP주소 등 여러 대상에 걸쳐 수신되는 트래픽을 자동으로 분산
- 등록된 대상의 상태를 모니터링 하면서 상태가 양호한 대상으로만 트래픽을 라우팅

## ELB 장점
1. 고가용성 : ELB는 여러 가용 영역에 걸쳐 배포되므로 단일 장애점(Single Point of Failure)이 없다.
2. 확장성 : ELB는 수요가 증가하면 **자동**으로 인스턴스를 추가하여 트래픽을 분산
3. 보안성: ELB는 SSL/TLS 암호화 및 AWS WAF(AWS Web Application Firewall)와 같은 보안 기능을 제공
4. 모니터링: ELB는 트래픽 분산 정보, 세션 상태, 트래픽 로그 등 다양한 정보를 모니터링
5. 탄력성 : ELB의 최대 장점은 **자동적 확장성** 입니다. 관리자는 인스턴스 추가 또는 삭제를 위한 어떤 수작업도 할 필요가 없다.
6. 높은 처리량 : ELB는 트래픽 증가를 처리할 수 있도록 설계되었으며 초당 수백만 개의 요청을 로드 밸런싱할 수 있다. 또한, 갑작스럽고 변동이 심한 트래픽 패턴도 처리

<br>

## 작동 방식
![ELB](/assets/img/AWS/ELB.png)

로드 밸런서 : 클라이언트에 대한 단일 접점, 클라이언트에서 오는 트래픽을 허용하고, 하나 이상의 가용 영역에서 등록된 대상(EC2 인스턴스)으로 요청을 라우팅  
- 등록된 타겟의 상태를 모니터링하고 정상 타겟으로만 트래픽이 라우팅 되도록 한다. 
- 로드 밸런서가 비정상 타겟을 감지하면, 해당 타겟으로 트래픽 라우팅을 중단 -> 타겟이 다시 정상으로 감지되면 트래픽을 해당 타겟으로 다시 라우팅

리스너 : 구성한 프로토콜 및 포트를 사용하여 클라이언트의 연결 요청을 확인
  - 리스너에 대해 정의한 규칙에 따라 로드 밸런서가 등록된 타겟으로 요청을 라우팅하는 방법이 결정
  - 각 규칙은 우선 순위, 하나 이상의 작업, 하나 이상의 조건으로 구성, 규칙에 대한 조건이 충족되면 작업이 수행  
    각 리스너에 대한 기본 규칙을 정의해야 하며, 필요에 따라 추가 규칙을 정의할 수 있다.

각 타겟 그룹은 지정한 프로토콜과 포트 번호를 사용하여 EC2 인스턴스 같은 하나 이상의 등록된 타겟으로 요청을 라우팅한다. 여러 대상 그룹에 타겟을 등록할 수 있으며 타겟 그룹 기준으로 상태 확인을 구성 가능하고 로드 밸런서의 리스너 규칙에서 지정한 타겟 그룹에 등록된 모든 타겟에서 헬스 체크를 수행한다.



## ELB 유형
### Application Load Balancer
**OSI 모델의 레이어 7**에 해당 - HTTP, HTTPS 지원  
로드 밸런서는 요청을 받으면 **우선 순위에 따라 리스너 규칙을 평가**하여, 적용할 규칙을 결정한 다음 규칙 작업의 타겟 그룹에서 타겟을 선택한다. 애플리케이션 트래픽의 콘텐츠를 기반으로 다른 타겟 그룹에 요청을 라우팅하도록 리스너 규칙을 구성

- ALB에서는 **헤더 수정**이 가능
- ALB의 호스트 기반 라우팅을 통해 HTTP 헤더의 Host 필드에 따라 클라이언트 요청을 라우팅 할 수 있고, 경로 기반 라우팅을 통해 HTTP 헤더의 URL 경로에 따라 클라이언트 요청을 라우팅 할 수 있다.


> **OSI 모델의 레이어 7** : **애플리케이션(Application) 레이어**, 최종 사용자와 직접 상호작용하는 소프트웨어 애플리케이션에 대한 프로토콜과 서비스를 제공
  레이어 7은 다른 모든 레이어와 상호작용하여 전체 통신 프로세스를 완성합니다. 이 레이어의 상위 레이어에서는 전송된 데이터를 더 이상 데이터 단위로 나누지 않으며, 하위 레이어에서는 데이터를 전송 가능한 단위로 분할합니다. 레이어 7은 이러한 하위 레이어의 동작에 대해 알지 못하며, 데이터의 표현과 사용자 인터페이스에만 집중합니다.


### Network Load Balancer
= **TCP Load Balancer** ( **OSI 모델의 레이어 4**에서 작동 )  

- TCP 트래핑의 경우, 로드 밸런서는 프로토콜, 원본 IP 주소, 원본 포트, 타겟 IP 주소, 타겟 포트, TCP 시퀀스 번호에 따라 흐름 해시 알고리즘을 사용하여 타겟을 선택 
  - 클라이언트로부터의 TCP 연결은 소스 포트와 시퀀스 번호가 서로 다르므로 다른 타겟에 라우팅될 수 있습니다. 각 TCP 연결은 연결 수명 동안 하나의 타겟에 라우팅.  
- UDP 트래픽의 경우, 로드 밸런서는 프로토콜, 원본 IP 주소, 원본 포트, 타겟 IP 주소, 타겟 포트에 따라 흐름 해시 알고리즘을 사용하여 타겟을 선택
  - 소스와 목적지가 동일하기 때문에 수명이 다할 때까지 일관되게 단일 타겟으로 라우트됩니다. 서로 다른 UDP 흐름에는 서로 다른 소스 IP 주소와 포트가 있으므로 다른 타겟으로 라우팅될 수 있다.

> TCP : 신뢰성 있는 데이터 전송을 위해 사용, 데이터의 분할과 재조립, 흐름 제어, 오류 제어 및 재전송 기능을 제공합니다.  
  UDP : 비신뢰성 데이터 전송을 위해 사용되며, TCP와는 달리 데이터의 분할과 재조립, 흐름 제어, 오류 제어 및 재전송 기능을 제공하지 않습니다.

> **OSI 모델의 레이어 4** : **전송 레이어(Transport)**, 시스템 간에 데이터를 전송하는 데 필요한 서비스와 프로토콜을 제공합니다. 데이터가 **신뢰성** 있게 전송되도록 여러 가지 기능을 수행합니다. 예를 들어, 데이터의 분할과 재조립, 오류 제어, 흐름 제어, 다중화 등이 있습니다. 이러한 기능을 수행하기 위해 레이어 4에서는 **TCP**(Transmission Control Protocol)와 UDP(User Datagram Protocol)와 같은 프로토콜을 사용합니다.


## 다중 AZ 활용
**AZ** : 물리적으로 분리된 여러 개의 데이터 센터로 구성된 지리적인 영역


***" Auto Scaling 과 ELB를 활용하여 애플리케이션을 구현할 때, 가능한 많은 AZ를 기반으로 할 것 "***

- AZ(Availability Zone)가 고가용성을 구현하기 위한 기본 구조이기 때문 !
- ELB가 트래픽을 AZ간에 균등 배분 -> AWS 생태계를 기반으로 서비스를 구현하면 다중 AZ 구조의 활용은 당연시 !

### 다중 AZ 활용 시 발생하는 문제점 및 해결
- **다중 AZ**를 사용하는 경우, 트래픽이 **특정 AZ로 집중되는 문제**가 발생할 수 있습니다. 이는 특정 AZ에 장애가 발생하면 전체 서비스의 가용성에 영향을 미칠 수 있습니다. 이러한 문제를 해결하기 위해 **Cross Zone Load Balancing**과 **Sticky Session**을 사용할 수 있습니다.

- **Cross Zone Load Balancing**은 각 **AZ에 균등하게 부하를 분산**시키는 기능입니다. 이를 통해 특정 AZ에 부하가 집중되는 현상을 줄일 수 있습니다.  
 <u>AWS의 Elastic Load Balancer(ELB)는 Cross Zone Load Balancing을 기본적으로 제공</u>합니다.

- **Sticky Session**은 **특정 사용자가 항상 같은 인스턴스로 요청을 보낼 수 있도록** 하는 기능입니다. 이를 통해 사용자의 세션이 특정 AZ에만 집중되는 현상을 줄일 수 있습니다. 
 <u>AWS의 ELB는 Sticky Session을 지원합니다.</u>

따라서, Cross Zone Load Balancing과 Sticky Session을 함께 사용하면 다중 AZ를 더욱 안정적으로 운영할 수 있습니다.

<br>
<br>
<br>

# Quiz

### 1. 내부 전용 애플리케이션의 아키텍처를 구상 중일 때 ELB를 통한 인터넷 접속을 원천적으로 막을 수 있는 방법은 다음 중 무엇입니까?


A.
ELB에서 인터넷 게이트웨이 분리


B.
프라이빗 서브넷에 인스턴스를 생성하고 ELB와 연결


C.
VPC에는 어떠한 인터넷 게이트웨이도 부착해서는 안됨


***D.콘솔에서 ELB를 생성할 때 내부용 혹은 외부용으로 정의 가능***  

#### [해설] 
ELB에서 인터넷 게이트웨이를 부착 또는 제거할 수 없으며, 이는 프라이빗 서브넷에 해당 인스턴스를 생성했을 때도 마찬가지입니다. 외부형 ELB 인스턴스를 생성하면 인터넷 연결이 가능해집니다.



### 2. 콘텐츠에 대한 캐싱의 장점을 최대한 살리기 위해 동일 인스턴스에 반복적으로 요청을 전달하는 기술을 고르시오.

***A.Sticky Session***

B.
다중 AZ


C.
크로스 존 로드 밸런싱


D.
인스턴스 별로 하나의 ELB 활용

#### 해설  
- 다중 AZ 구조에서 워크로드를 다수의 AZ로 분산할 수 있지만, 동일한 인스턴스로 요청을 되돌려 보낼 수는 없습니다.
- 크로스 존 로드 밸런싱은 우회 캐싱 기법을 사용합니다.
- 하나의 인스턴스 마다 하나의 ELB를 적용하면 복잡성이 증대 됩니다.

### 3. ELB와 ASG가 설정된 구조에서 타겟그룹에 대한 헬스체크가 실패하면 어떤일이 벌어지는지 가장 알맞은 답을 고르세요.


A.
Elastic Load Balancing이 실패하면 다른 로드 밸런서를 실행시킴


B.
Elastic Load Balancing은 인스턴스가 응답할 때까지 계속 회신을 요청함


***C. Elastic Load Balancing이 해당 인스턴스에 대한 트래픽을 차단하고 새 인스턴스를 실행시킴***

D.
로드 밸런서는 용량이 더 큰 인스턴스를 실행시킴

#### [해설]
Elastic Load Balancing의 페일오버(failover) 전략의 작동 메커니즘은 최종 사용자에게 투명하게 공개돼 있습니다. 실패 상황에도 불구하고 Elastic Load Balancing을 지속적으로 시도하지만, 일정 시간 내에 인스턴스의 응답이 없는 경우 새 인스턴스를 시작합니다. Elastic Load Balancing은 무한정 인스턴스의 응답을 기다리지는 않습니다.
로드 밸런서가 실행하는 새 인스턴스의 내역은 시작 구성(시작 템플릿)에 정의되어 있으며, 관리자가 직접 시작 템플릿(시작 구성)을 변경해 좀 더 큰 용량의 인스턴스 타입을 지정하지 않는 한 기존과 동일한 인스턴스 타입이 시작됩니다.


### 4. 서버를 위한 Auto Scaling 메커니즘을 생성할 때 두 가지 필수적인 요소는 무엇입니까? (정답 2개)


A.
Elastic Load Balancer


***B.시작 템플릿***


C.
DNS 연결


***D. Auto Scaling 그룹***

#### [해설]
시작 템플릿(시작 구성) 설정과 Auto Scaling 그룹에 대한 정의는 의무사항입니다.

### 5. Auto Scaling을 이용해 서버를 론칭 할 때, 서버 타입에 대한 세부사항은 어디서 정의할 수 있습니까?


A.
Auto Scaling 그룹

***B.시작 템플릿***


C.
Elastic Load Balancer


D.
Application Load Balancer

#### [해설]
론칭할 서버의 타입은 시작 템플릿에 정의 합니다.  
Auto Scaling 그룹은 스케일링 정책을 정의하며, 일래스틱 로드 밸런싱은 다수의 인스턴스 간에 트래픽을 배분하는데 사용되고,  
애플리케이션 로드 밸런서는 OSI 모델의 레이어 7에 해당 HTTP/HTTPS 트래픽을 배분합니다.

<br>
<br>
<br>